<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Login - CSV Table Proof</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family: Arial; display:flex; justify-content:center; align-items:flex-start; padding-top:50px; background:#f4f4f4; }
    .box { background:white; padding:30px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:420px; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border-radius:4px; border:1px solid #ccc; }
    button { background:black; color:white; border:none; cursor:pointer; }
    button:hover { background:#333; }
    #message { text-align:center; color:gray; margin-top:10px; }
    #uploadUI { display:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    td, th { border:1px solid #ccc; padding:5px; text-align:left; }
    th { background:#f0f0f0; }
  </style>
</head>
<body>

<div class="box">
  <div id="loginUI">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button onclick="login()">Log In</button>
    <div id="message"></div>
  </div>

  <div id="uploadUI">
    <h2>Welcome, Admin!</h2>
    <input type="file" id="csvInput" accept=".csv">
    <button onclick="uploadCSV()">Upload CSV</button>
    <div id="uploadMessage"></div>
    <div id="csvDisplay"></div>
  </div>
</div>

<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyCGnRRcRQOVWdloCg6-PSj2l4EDnR-CzqI",
    authDomain: "campagqtest-754b1.firebaseapp.com",
    projectId: "campagqtest-754b1",
    storageBucket: "campagqtest-754b1.firebasestorage.app",
    messagingSenderId: "378599524521",
    appId: "1:378599524521:web:0d8ea66ccee8e7349b41b8"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const storage = firebase.storage();

  // --- Login function ---
  function login() {
    const usernameInput = document.getElementById("username").value.trim().toLowerCase();
    const password = document.getElementById("password").value;
    const message = document.getElementById("message");

    if (!usernameInput) {
      message.style.color = "red";
      message.innerText = "Enter a username";
      return;
    }

    const email = usernameInput + "@camp.local";

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        message.style.color = "green";
        message.innerText = "Logged in!";
        document.getElementById("loginUI").style.display = "none";
        document.getElementById("uploadUI").style.display = "block";
        displayMostRecentCSV();
      })
      .catch(err => {
        console.error(err);
        message.style.color = "red";
        message.innerText = err.code === "auth/wrong-password" ? "Invalid password" :
                             err.code === "auth/user-not-found" ? "User does not exist" :
                             "Login failed";
      });
  }

  // --- Upload CSV ---
  function uploadCSV() {
    const fileInput = document.getElementById("csvInput");
    const file = fileInput.files[0];
    const msg = document.getElementById("uploadMessage");

    if (!file) {
      msg.style.color = "red";
      msg.innerText = "Select a CSV file first";
      return;
    }

    if (!auth.currentUser) {
      msg.style.color = "red";
      msg.innerText = "You must log in first";
      return;
    }

    const storageRef = storage.ref('csv/' + file.name);
    storageRef.put(file)
      .then(() => {
        msg.style.color = "green";
        msg.innerText = "CSV uploaded!";
        fileInput.value = "";
        displayCSV(file.name);
      })
      .catch(err => {
        console.error(err);
        msg.style.color = "red";
        msg.innerText = "Upload failed";
      });
  }

  // --- Render CSV as table ---
  function renderCSVToTable(csvText, containerId) {
    const rows = csvText.trim().split('\n').map(r => r.split(','));
    const table = document.createElement('table');

    rows.forEach((row, i) => {
      const tr = document.createElement('tr');
      row.forEach(cell => {
        const td = document.createElement(i===0 ? 'th' : 'td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });

    const container = document.getElementById(containerId);
    container.innerHTML = '';
    container.appendChild(table);
  }

  // --- Display CSV from Firebase ---
  function displayCSV(filename) {
    const displayDiv = document.getElementById("csvDisplay");
    const fileRef = storage.ref('csv/' + filename);
    fileRef.getDownloadURL()
      .then(url => fetch(url))
      .then(res => res.text())
      .then(text => renderCSVToTable(text, "csvDisplay"))
      .catch(err => {
        console.error(err);
        displayDiv.innerHTML = '<p>Unable to display CSV</p>';
      });
  }

  // --- Display most recent CSV ---
  function displayMostRecentCSV() {
    const listRef = storage.ref('csv/');
    listRef.list({ maxResults: 1 })
      .then(res => {
        if (res.items.length > 0) {
          const latestFile = res.items[res.items.length - 1].name;
          displayCSV(latestFile);
        }
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>
