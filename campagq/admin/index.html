<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Login</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family: Arial; display:flex; justify-content:center; align-items:flex-start; padding-top:50px; background:#f4f4f4; }
    .box { background:white; padding:30px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:350px; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border-radius:4px; border:1px solid #ccc; }
    button { background:black; color:white; border:none; cursor:pointer; }
    button:hover { background:#333; }
    #message { text-align:center; color:gray; margin-top:10px; }
    #uploadUI { display:none; }
    #uploadedFile { margin-top:15px; text-align:center; }
    #uploadedFile img { max-width:100%; border-radius:4px; }
    #uploadedFile a { display:block; margin-top:5px; color:#007BFF; text-decoration:none; }
  </style>
</head>
<body>

<div class="box">
  <div id="loginUI">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button onclick="login()">Log In</button>
    <div id="message"></div>
  </div>

  <div id="uploadUI">
    <h2>Welcome, Admin!</h2>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload File</button>
    <div id="uploadMessage"></div>
    <div id="uploadedFile"></div>
  </div>
</div>

<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyCGnRRcRQOVWdloCg6-PSj2l4EDnR-CzqI",
    authDomain: "campagqtest-754b1.firebaseapp.com",
    projectId: "campagqtest-754b1",
    storageBucket: "campagqtest-754b1.firebasestorage.app",
    messagingSenderId: "378599524521",
    appId: "1:378599524521:web:0d8ea66ccee8e7349b41b8"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const storage = firebase.storage();

  // --- Login function ---
  function login() {
    const usernameInput = document.getElementById("username").value.trim().toLowerCase();
    const password = document.getElementById("password").value;
    const message = document.getElementById("message");

    if (!usernameInput) {
      message.style.color = "red";
      message.innerText = "Enter a username";
      return;
    }

    const email = usernameInput + "@camp.local";

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        message.style.color = "green";
        message.innerText = "Logged in!";
        document.getElementById("loginUI").style.display = "none";
        document.getElementById("uploadUI").style.display = "block";
        displayMostRecentFile();
      })
      .catch(err => {
        console.error(err);
        if (err.code === "auth/wrong-password") {
          message.style.color = "red";
          message.innerText = "Invalid password";
        } else if (err.code === "auth/user-not-found") {
          message.style.color = "red";
          message.innerText = "User does not exist";
        } else {
          message.style.color = "red";
          message.innerText = "Login failed";
        }
      });
  }

  // --- Upload function ---
  function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    const msg = document.getElementById("uploadMessage");

    if (!file) {
      msg.style.color = "red";
      msg.innerText = "Select a file first";
      return;
    }

    if (!auth.currentUser) {
      msg.style.color = "red";
      msg.innerText = "You must log in first";
      return;
    }

    const storageRef = storage.ref('uploads/' + file.name);
    storageRef.put(file)
      .then(() => {
        msg.style.color = "green";
        msg.innerText = "File uploaded!";
        fileInput.value = ""; // clear input
        displayFile(file.name);
      })
      .catch(err => {
        console.error(err);
        msg.style.color = "red";
        msg.innerText = "Upload failed";
      });
  }

  // --- Display a file ---
  function displayFile(filename) {
    const uploadedDiv = document.getElementById("uploadedFile");
    const fileRef = storage.ref('uploads/' + filename);

    fileRef.getDownloadURL()
      .then(url => {
        // Check file type to display image or link
        const lower = filename.toLowerCase();
        if (lower.endsWith('.png') || lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.gif')) {
          uploadedDiv.innerHTML = `<img src="${url}" alt="Uploaded file">`;
        } else {
          uploadedDiv.innerHTML = `<a href="${url}" target="_blank">Download ${filename}</a>`;
        }
      })
      .catch(err => {
        console.error(err);
        uploadedDiv.innerHTML = '';
      });
  }

  // --- Display the most recent file ---
  function displayMostRecentFile() {
    const listRef = storage.ref('uploads/');

    // List files and take the last one
    listRef.list({ maxResults: 1 }) // list most recent file (alphabetically, workaround)
      .then(res => {
        if (res.items.length > 0) {
          const latestFile = res.items[res.items.length - 1].name;
          displayFile(latestFile);
        }
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>
